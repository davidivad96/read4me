# ReadForMe CDK Stack

![Stability: Stable](https://img.shields.io/badge/stability-Stable-success.svg?style=for-the-badge)

> **This is a stable project. It should successfully build out of the box**
>
> This project is built on Construct Libraries marked "Stable" and does not have any infrastructure prerequisites to build.

---

This project creates a AWS StepFunctions State Machine that will read a text file and transform it to audio (text-to-speech workflow). The text file is read from a S3 Bucket (/documents folder) and the audio file is written to the same S3 Bucket (/results folder). A AWS EventBridge rule is defined to trigger the state machine execution when a file is uploaded to the /documents folder of your S3 Bucket.

## State Machine Graph

![Graph](./images/state-machine-graph.png)

- 1 `Start`
- 2 `Check Document`: Invoke CheckDocument Lambda which checks that the file is valid (valid format and size).
  - 2.1 `Setup Topic And Queue`: Invoke SetupTopicAndQueue Lambda which creates a SNS Topic, SQS Queue and subscription between them. We will need it later.
    - 2.1.1 `Start Document Text Detection`: Call to AWS Textract StartDocumentTextDetection API to start the asynchronous process of text detection. When the job is finished, a message will be sent to the SNS Topic previously created.
    - 2.2.2 `Receive Textract Job Message`: Try to receive SQS job status message from AWS Textract.
    - 2.2.3 `Choice: Check If Received Textract Job Message`: Loop to wait for the AWS Textract job status message to be received.
    - 2.2.4: `Delete Textract Job Message`: Delete AWS Textract job status message from the SQS Queue.
    - 2.2.5: `Get Document Text Detection`: Call to AWS Textract GetDocumentTextDetection API to retrieve the actual text extracted from the document.
    - 2.2.6: `Transform Blocks To Text`: Invoke TransformBlocksToText Lambda to convert the response from AWS Textract GetDocumentTextDetection API into a more suitable format.
      - 2.2.6.1: `Detect Dominant Language`: Call to AWS Comprehend DetectDominantLanguage API to get the language in which the document is written.
        - 2.2.6.1.1: `Get Voice Id`: Invoke GetVoiceId Lambda to get a voice id which supports the detected dominant language.
        - 2.2.6.1.2: `Start Speech Synthesis`: Call to AWS Polly StartSpeechSynthesisTask API to start the asynchronous process of speech synthesis. When the task is finished, a message will be sent to the SNS Topic previously created.
        - 2.2.6.1.3: `Receive Polly Task Message`: Try to receive SQS task status message from AWS Polly.
        - 2.2.6.1.4: `Choice: Check If Received Polly Task Message`: Loop to wait for the AWS Polly task status message to be received.
        - 2.2.6.1.5: `Delete Polly Task Message`: Delete AWS Polly task status message from the SQS Queue.
        - 2.2.6.1.6: `Get Speech Synthesis`: Call to AWS Polly GetSpeechSynthesisTask API to retrieve the information about the synthesis task.
        - 2.2.6.1.7: `Cleanup Topic And Queue 2`: Invoke CleanupTopicAndQueue Lambda which deletes the SNS Topic, SQS Queue and subscription between them.
      - 2.2.6.2: `Cleanup Topic And Queue 1`: Invoke CleanupTopicAndQueue Lambda which deletes the SNS Topic, SQS Queue and subscription between them.
        - 2.2.6.2.1: `Fail: No Text Found`: Fail state when no text is found in the document.
  - 2.2 `Fail: Document Too Large`: Fail state when the document is too large (max: 5MB).
  - 2.3 `Fail: Unsupported Document`: Fail state when the document extension is not supported (supported formats: PDF, PNG, JPG, JPEG and TIFF).

## Bootstrap

If it's the first time you use CDK in your account it's probably that you need to bootstrap your environment before deploying your Stack. Just run run `npm run cdk-bootstrap <aws-profile> <account-id> <region>`. This will create the necessary resources for you to deploy your Stack.

## Deploy

Run `npm run cdk-deploy <aws-profile> <account-id> <region>`. This will deploy / redeploy your Stack to your AWS Account.

## Destroy

Just run `npm run cdk-destroy <aws-profile> <account-id> <region>`. This will destroy your Stack.

## Synthesize Cloudformation Template

To see the Cloudformation template generated by the CDK, run cdk synth, then check the output file in the "cdk.out" directory.

## How to test that the Stack works

Just try uploading a file to your S3 Bucket /documents folder (you should create this folder first). You can see how the state machine execution is triggered and check that each step is performed correctly from the AWS Step Functions console. After less than 1 minute the state machine will finish and the audio file will be available in your S3 Bucket /results folder.
